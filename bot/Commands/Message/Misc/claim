const { Message, PermissionFlagsBits, Client, EmbedBuilder } = require("discord.js");
const moment = require("moment");
const Code = require("../../../Models/Code");
const Membership = require("../../../Models/User");

module.exports = {
  name: "claim",
  description: `Redeem membership codes`,
  userPermissions: PermissionFlagsBits.Administrator,
  botPermissions: PermissionFlagsBits.SendMessages,
  category: "Misc",
  type1: "message",
  cooldown: 5,
  run: async (client, message, args, prefix) => {
    try {
      const code = args[0];
      if (!code) {
        return message.reply({
          content: `**Please specify the code you want to redeem!**`,
        });
      }

      let server = await Membership.findOne({ Id: message.guild.id });
      if (server && server.ismembership) {
        return message.reply({
          content: `**> This server is already in membership mode**`,
        });
      }

      const membershipCode = await Code.findOne({ code: code.toUpperCase() });
      if (!membershipCode) {
        return message.reply({
          content: `**The code is invalid. Please try again using a valid one!**`,
        });
      }
      if (membershipCode.used) {
        return message.reply({
          content: `**This code has already been used.**`,
        });
      }

      const expires = moment(membershipCode.expiresAt).format("dddd, MMMM Do YYYY HH:mm:ss");

      if (!server) {
        server = new Membership({ Id: message.guild.id });
      }

      server.ismembership = true;
      server.membership.redeemedBy.push({ id: message.author.id, tag: message.author.tag });
      server.membership.redeemedAt = Date.now();
      server.membership.expiresAt = membershipCode.expiresAt;
      server.membership.plan = membershipCode.plan;
      await server.save();

      client.userSettings.set(message.guild.id, server);

      membershipCode.used = true;
      await membershipCode.save();

      // Logging can be improved to be more dynamic
      const logChannel = await client.channels.fetch('1228751003206025337').catch(() => null);
      if (logChannel) {
        const embed = new EmbedBuilder()
          .setColor(0xefc75e)
          .setTitle(`Code Claimed: ${message.guild.name}`)
          .addFields(
            { name: 'Server ID', value: `\`${message.guild.id}\``, inline: true },
            { name: 'Code', value: `\`${code}\``, inline: true },
            { name: 'Plan', value: membershipCode.plan, inline: true },
            { name: 'Redeemed By', value: message.author.tag, inline: true },
          )
          .setTimestamp();
        await logChannel.send({ embeds: [embed] });
      }

      return message.reply({
        content: `**You have successfully redeemed membership!**\n\n\`Expires at: ${expires}\``,
      });

    } catch (error) {
      console.error("Error in claim message command:", error);
      await message.reply({
        content: "An error occurred while processing your request.",
      }).catch(() => {});
    }
  },
};
