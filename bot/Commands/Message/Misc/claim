const { Message, PermissionFlagsBits, Client, EmbedBuilder } = require("discord.js");
const moment = require("moment");
const Code = require("../../../Models/Code");
const Server = require("../../../Models/User"); // تأكد من أن هذا المسار صحيح

module.exports = {
  name: "claim",
  description: `redeem membership codes`,
  userPermissions: PermissionFlagsBits.Administrator,
  botPermissions: PermissionFlagsBits.SendMessages,
  category: "Misc",
    type1: "message",
  cooldown: 5,
  /**
   *
   * @param {Client} client
   * @param {Message} message
   * @param {String[]} args
   * @param {String} prefix
   */
  run: async (client, message, args, prefix) => {
    // Code
    let code = args.join(" "); // `!redeem ABCD-EFGH-IJKL`
    let server = await Server.findOne({
      Id: message.guild.id
    });

    // Return an error if the User does not include any membership Code
    if (!code) {
      return message.reply({
        content: `**Please specify the code you want to redeem!**`,
      });
    } else if (server && server.ismembership) {
      // If the server is already a membership server, we dont want to save that so we return it.
      return message.reply({
        content: `**> This server is already in membership mode**`,
      });
    } else {
      // Check if the code is valid within the database
      const membership = await Code.findOne({
        code: code.toUpperCase(),
      });

      // Set the expire date for the membership code
      if (membership) {
        const expires = moment(membership.expiresAt).format(
          "dddd, MMMM Do YYYY HH:mm:ss"
        );

        if (!server) {
          server = new Server({
            Id: message.guild.id,
            ismembership: false,
            membership: {
              redeemedBy: [],
              redeemedAt: null,
              expiresAt: null,
              plan: null
            }
          });
        }

        // Once the code is expired, we delete it from the database and from the users profile
        server.ismembership = true;
        server.membership.redeemedBy.push({
          id: message.guild.id,
          tag: message.guild.name,
        });
        server.membership.redeemedAt = Date.now();
        server.membership.expiresAt = membership.expiresAt;
        server.membership.plan = membership.plan;

        // Save the Server within the Database
        server = await server.save().catch((error) => {
          console.error(`Failed to save server: ${error}`);
        });

        client.userSettings.set(message.guild.id, server);

        membership.used = true;
        await membership.save().catch((error) => {
          console.error(`Failed to save membership: ${error}`);
        });
        const targetRoom = await client.channels.fetch('1228751003206025337');
        if (!targetRoom) return console.error('Invalid target room ID!');

        const embed = new EmbedBuilder()
            .setColor(0xefc75e)
            .setTitle(`New code claimer has been saved from ${message.guild.name}`)
            .addFields(
                { name: 'Server Id', value: `( ${message.guild.id} )`, inline: true },
                { name: 'Code', value: ` \`${code}\` `, inline: true },
                { name: 'Plan', value: ` ${server.plan} `, inline: true },
                { name: 'Redeem By', value: ` ${message.author.tag} `, inline: true },
                { name: 'Redeem At', value: ` ${moment().format('dddd, MMMM Do YYYY HH:mm:ss') }`, inline: true },
            )
            .setTimestamp();

        await targetRoom.send({ embeds: [embed] });
        // Send a success message once redeemed
        return message.reply({
          content: `**You have successfully redeemed membership!**\n\n\`Expires at: ${expires}\``,
        });
        
        // Error message if the code is not valid.
      } else {
        return message.reply({
          content: `**The code is invalid. Please try again using a valid one!**`,
        });
      }
    }
  },
};
