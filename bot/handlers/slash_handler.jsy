const { Client, Collection } = require("discord.js");
const { readdirSync } = require("fs");
const path = require('path');
const { REST, Routes } = require("discord.js");
require('dotenv-flow').config();

module.exports = async (client) => {
  try {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªÙˆÙƒÙ†
    if (!process.env.BOT1_1_TOKEN) {
      throw new Error("Bot token is not defined in environment variables");
    }

    client.scommands = new Collection();
    let allCommands = [];

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯
    const loadCommands = () => {
      try {
        const slashPath = path.join(__dirname, "..", "Commands", "Slash");
        readdirSync(slashPath).forEach((dir) => {
          const commands = readdirSync(`${slashPath}/${dir}`).filter(f => f.endsWith(".js"));
          
          for (const cmd of commands) {
            const command = require(`../Commands/Slash/${dir}/${cmd}`);
            if (command?.name && command?.description && command?.run) {
              client.scommands.set(command.name, command);
              allCommands.push({
                name: command.name,
                description: command.description,
                options: command.options || []
              });
            }
          }
        });
        console.log(`âœ… Loaded ${client.scommands.size} slash commands`);
      } catch (error) {
        console.error("âŒ Error loading commands:", error);
      }
    };

    loadCommands();

    // 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¹Ù†Ø¯ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¨ÙˆØª
    client.once("ready", async () => {
      try {
        if (!client.user?.id) {
          throw new Error("Client user not available");
        }

        const rest = new REST({ version: "10" }).setToken(process.env.BOT1_1_TOKEN);
        const clientId = client.user.id;

        // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù… (Global)
        try {
          await rest.put(
            Routes.applicationCommands(clientId),
            { body: allCommands }
          );
          console.log("ðŸŒ Successfully registered GLOBAL slash commands");
          return;
        } catch (globalError) {
          console.warn("âš ï¸ Global registration failed, trying guild-specific...");
        }

        // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙ‚Ø·
        const GUILD_ID = process.env.TEST_GUILD_ID || "1226151054178127872"; // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù…Ø¹Ø±Ù Ø³ÙŠØ±ÙØ±Ùƒ
        await rest.put(
          Routes.applicationGuildCommands(clientId, GUILD_ID),
          { body: allCommands }
        );
        console.log(`ðŸ° Successfully registered GUILD slash commands for ${GUILD_ID}`);

      } catch (error) {
        console.error("âŒ Failed to register slash commands:", error);
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©
        if (error.code === 50001) {
          console.error("ðŸ”’ Missing 'Applications Commands' scope in bot invite link");
        } else if (error.code === 20012) {
          console.error("ðŸš« Bot lacks permission to manage application commands");
        }
      }
    });

    // 4. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙƒÙ„ Ø³Ø§Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    setInterval(() => {
      loadCommands();
    }, 3600000);

  } catch (error) {
    console.error("ðŸ’¥ Critical error in slash handler:", error);
  }
};